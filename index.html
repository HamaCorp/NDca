<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ND„Çø„Ç§„Éû„Éº</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ND„Çø„Ç§„Éû„Éº">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <style>
        :root { --accent-color: #007bff; --success-color: #28a745; --danger-color: #dc3545; }
        html, body { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.5; color: #333; background-color: #f0f2f5; margin: 0;
            display: flex; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box;
        }
        .container {
            background: #fff; padding: 20px 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%; max-width: 400px;
        }
        h1 { text-align: center; color: #1a1a1a; margin: 0 0 20px 0; font-size: 1.5em; }
        
        /* ÂÖ•Âäõ„Ç®„É™„Ç¢„ÇíGrid„É¨„Ç§„Ç¢„Ç¶„Éà„Åß„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
        .input-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px;
            align-items: center;
            margin-bottom: 15px;
        }
        .input-grid label {
            font-weight: normal; color: #333; margin: 0;
        }
        .input-grid select, .input-grid input {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; box-sizing: border-box;
        }
        .input-grid .custom-input {
            grid-column: 1 / -1; /* Ê®™ÂπÖ„ÅÑ„Å£„Å±„ÅÑ„Å´Â∫É„Åí„Çã */
            display: none;
        }

        #result-speed {
            font-size: 1.8em; font-weight: bold; color: var(--accent-color); text-align: center; margin: 15px 0 10px 0;
            padding: 10px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee;
        }

        .timer-section { text-align: center; display: none; }
        #timer-display { font-size: 3em; font-weight: bold; color: var(--success-color); margin-bottom: 10px; letter-spacing: 2px; }
        
        .timer-settings { margin-bottom: 10px; }
        .timer-settings label { display: inline-flex; align-items: center; cursor: pointer; font-weight: normal; color: #555; }
        
        .timer-controls { display: flex; justify-content: space-between; }
        .timer-controls button {
            flex-grow: 1; padding: 12px 10px; font-size: 1em; margin: 0 4px; cursor: pointer;
            border-radius: 8px; border: none; color: white; transition: opacity 0.2s;
        }
        .timer-controls button:active { opacity: 0.7; }
        #start-timer { background-color: var(--success-color); }
        #stop-timer { background-color: var(--danger-color); }
        #reset-timer { background-color: #6c757d; }

        #network-warning { display: none; background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; font-size: 0.9em;}
    </style>
</head>
<body>

<div class="container">
    <div id="network-warning">„Ç≠„É£„ÉÉ„Ç∑„É•‰ΩúÊàê„ÅÆ„Åü„ÇÅÈÄö‰ø°‰∏≠„Åß„Åô„ÄÇÂÆå‰∫ÜÂæå„ÅØ„Ç™„Éï„É©„Ç§„É≥„ÅßÂà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ</div>
    <h1>üì∑ ND Filter Timer</h1>

    <div class="input-grid">
        <label for="base-speed-select">ND„Å™„Åó</label>
        <select id="base-speed-select">
            <option value="0.000125">1/8000</option>
            <option value="0.00025">1/4000</option>
            <option value="0.002">1/500</option>
            <option value="0.008">1/125</option>
            <option value="0.01666">1/60</option>
            <option value="0.06666">1/15</option>
            <option value="0.5">1/2</option>
            <option value="1">1Áßí</option>
            <option value="custom">„Ç´„Çπ„Çø„É†</option>
        </select>
        <input type="text" id="custom-speed-input" class="custom-input" placeholder="‰æã: 1/100, 15 „Å™„Å©">

        <label for="nd-filter">ND„Éï„Ç£„É´„Çø„Éº</label>
        <select id="nd-filter">
            <option value="1000" selected>ND1000</option>
            <option value="500">ND500</option>
            <option value="64">ND64</option>
            <option value="8">ND8</option>
            <option value="custom">„Ç´„Çπ„Çø„É†</option>
        </select>
        <input type="text" id="custom-nd-value" class="custom-input" placeholder="‰æã: 8x64">
    </div>

    <div id="result-speed">-</div>

    <div id="timer-container" class="timer-section">
        <div id="timer-display">0.0</div>
        <div class="timer-settings">
            <label><input type="checkbox" id="sound-toggle" checked> ÁµÇ‰∫ÜÈü≥</label>
        </div>
        <div class="timer-controls">
            <button id="start-timer">„Çπ„Çø„Éº„Éà</button>
            <button id="stop-timer">„Çπ„Éà„ÉÉ„Éó</button>
            <button id="reset-timer">„É™„Çª„ÉÉ„Éà</button>
        </div>
    </div>
</div>

<script>
    // DOMË¶ÅÁ¥†
    const baseSpeedSelect = document.getElementById('base-speed-select');
    const customSpeedInput = document.getElementById('custom-speed-input');
    const ndFilterSelect = document.getElementById('nd-filter');
    const customNdInput = document.getElementById('custom-nd-value');
    const resultSpeedEl = document.getElementById('result-speed');
    const timerContainer = document.getElementById('timer-container');
    const timerDisplay = document.getElementById('timer-display');
    const soundToggle = document.getElementById('sound-toggle');
    const startTimerBtn = document.getElementById('start-timer');
    const stopTimerBtn = document.getElementById('stop-timer');
    const resetTimerBtn = document.getElementById('reset-timer');
    const networkWarning = document.getElementById('network-warning');

    let totalSeconds = 0, timerInterval = null, remainingSeconds = 0, audioContext = null;

    function initAudioContext() {
        if (!audioContext) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const buffer = audioContext.createBuffer(1, 1, 22050);
                const source = audioContext.createBufferSource();
                source.buffer = buffer; source.connect(audioContext.destination); source.start(0);
            } catch (e) { console.error("Web Audio API not supported."); }
        }
        if (audioContext && audioContext.state === 'suspended') audioContext.resume();
    }
    function playBeep() {
        if (!audioContext) return;
        const o = audioContext.createOscillator(), g = audioContext.createGain();
        o.connect(g); g.connect(audioContext.destination); o.type = 'sine';
        o.frequency.value = 880; g.gain.setValueAtTime(0, audioContext.currentTime);
        g.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.02); o.start(audioContext.currentTime);
        g.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3); o.stop(audioContext.currentTime + 0.3);
    }
    function performCalculation() {
        stopTimer();
        let baseSpeedSec;
        if (baseSpeedSelect.value === 'custom') {
            const str = customSpeedInput.value;
            baseSpeedSec = str.includes('/') ? parseFloat(str.split('/')[0]) / parseFloat(str.split('/')[1]) : parseFloat(str);
        } else { baseSpeedSec = parseFloat(baseSpeedSelect.value); }
        let ndFactor;
        if (ndFilterSelect.value === 'custom') {
            const str = customNdInput.value.toLowerCase();
            ndFactor = str.includes('x') ? str.split('x').reduce((acc, val) => acc * parseFloat(val), 1) : parseFloat(str);
        } else { ndFactor = parseFloat(ndFilterSelect.value); }
        if (isNaN(baseSpeedSec) || isNaN(ndFactor) || baseSpeedSec <= 0 || ndFactor <= 0) {
            resultSpeedEl.textContent = "-"; timerContainer.style.display = 'none'; return;
        }
        totalSeconds = baseSpeedSec * ndFactor;
        if (totalSeconds < 1) {
            const frac = 1 / totalSeconds, roundFrac = Math.round(frac);
            resultSpeedEl.textContent = (Math.abs(frac - roundFrac) < 0.01 && roundFrac > 0) ? `1/${roundFrac} Áßí` : `${totalSeconds.toFixed(2)} Áßí`;
        } else { resultSpeedEl.textContent = `${totalSeconds.toFixed(1)} Áßí`; }
        if (totalSeconds >= 1) {
            remainingSeconds = totalSeconds;
            timerDisplay.textContent = totalSeconds.toFixed(1); timerContainer.style.display = 'block';
        } else { timerContainer.style.display = 'none'; }
    }
    function startTimer() {
        if (timerInterval || remainingSeconds <= 0) return;
        initAudioContext();
        const endTime = Date.now() + remainingSeconds * 1000;
        timerInterval = setInterval(() => {
            const newRemaining = (endTime - Date.now()) / 1000;
            if (newRemaining <= 0) {
                stopTimer(); timerDisplay.textContent = "0.0";
                if (soundToggle.checked) playBeep();
                setTimeout(() => alert("„Çø„Ç§„Éû„Éº„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ"), 100);
            } else { remainingSeconds = newRemaining; timerDisplay.textContent = newRemaining.toFixed(1); }
        }, 100);
    }
    function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
    function resetTimer() { stopTimer(); if (totalSeconds >= 1) { remainingSeconds = totalSeconds; timerDisplay.textContent = totalSeconds.toFixed(1); } }

    [baseSpeedSelect, customSpeedInput, ndFilterSelect, customNdInput].forEach(el => {
        el.addEventListener('change', performCalculation);
        el.addEventListener('input', performCalculation);
    });
    baseSpeedSelect.addEventListener('change', () => { customSpeedInput.style.display = baseSpeedSelect.value === 'custom' ? 'block' : 'none'; });
    ndFilterSelect.addEventListener('change', () => { customNdInput.style.display = ndFilterSelect.value === 'custom' ? 'block' : 'none'; });
    
    startTimerBtn.addEventListener('click', startTimer);
    stopTimerBtn.addEventListener('click', stopTimer);
    resetTimerBtn.addEventListener('click', resetTimer);

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('Service worker registration failed:', err));
        });
        navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.type === 'NETWORK_ACCESS') {
                networkWarning.style.display = 'block'; setTimeout(() => { networkWarning.style.display = 'none'; }, 4000);
            }
        });
    }
    performCalculation();
</script>

</body>
</html>
